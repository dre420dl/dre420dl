import React, { useState, useEffect, useRef } from 'react';
import { 
  StyleSheet, Text, View, TextInput, Switch, ScrollView, 
  TouchableOpacity, Animated, ActivityIndicator, Alert, Dimensions 
} from 'react-native';
import AsyncStorage from '@react-native-async-storage/async-storage';
import * as Notifications from 'expo-notifications';
import * as BackgroundFetch from 'expo-background-fetch';
import * as TaskManager from 'expo-task-manager';

// --- CONFIGURATION & BACKGROUND TASKS ---
const BACKGROUND_TASK = 'DEFI_PROFIT_CHECK';
const TRACKED_TOKENS = [
  { id: 'ethereum', symbol: 'ETH', gasLimit: 200000 },
  { id: 'chainlink', symbol: 'LINK', gasLimit: 200000 },
];

// 1. Define the Background Worker (Global Scope)
TaskManager.defineTask(BACKGROUND_TASK, async () => {
  try {
    const thresholdStr = await AsyncStorage.getItem('@profit_threshold');
    const threshold = thresholdStr ? parseFloat(thresholdStr) : 50;
    
    // Logic: Fetch ETH Price + Gas -> Check Arbitrage Spreads
    // If Profit > threshold, Notifications.scheduleNotificationAsync(...)
    return BackgroundFetch.BackgroundFetchResult.NewData;
  } catch (err) {
    return BackgroundFetch.BackgroundFetchResult.Failed;
  }
});

export default function App() {
  // --- STATE ---
  const [prices, setPrices] = useState({ ethereum: 0, chainlink: 0 });
  const [gasGwei, setGasGwei] = useState(0);
  const [slippage, setSlippage] = useState('1');
  const [threshold, setThreshold] = useState('50');
  const [isSimMode, setIsSimMode] = useState(true);
  const [isDarkMode, setIsDarkMode] = useState(true);
  const [isLoading, setIsLoading] = useState(false);
  const fadeAnim = useRef(new Animated.Value(1)).current;

  // --- LOGIC: FETCHING ---
  const refreshMarketData = async () => {
    setIsLoading(true);
    // Flash Animation
    Animated.sequence([
      Animated.timing(fadeAnim, { toValue: 0.4, duration: 200, useNativeDriver: true }),
      Animated.timing(fadeAnim, { toValue: 1, duration: 200, useNativeDriver: true }),
    ]).start();

    try {
      const [pRes, gRes] = await Promise.all([
        fetch('https://api.coingecko.com/api/v3/simple/price?ids=ethereum,chainlink&vs_currencies=usd'),
        fetch('https://api.etherscan.io/api?module=gwei&action=gasoracle&apikey=YOUR_KEY')
      ]);
      const pData = await pRes.json();
      const gData = await gRes.json();
      
      setPrices({ ethereum: pData.ethereum.usd, chainlink: pData.chainlink.usd });
      setGasGwei(parseFloat(gData.result?.ProposeGasPrice || 20));
    } catch (e) { console.error("Refresh failed"); }
    setIsLoading(false);
  };

  useEffect(() => {
    refreshMarketData();
    const interval = setInterval(refreshMarketData, 15000); // 15s Pulse
    return () => clearInterval(interval);
  }, []);

  // --- LOGIC: ARBITRAGE MATH ---
  const calculateArb = (id) => {
    const price = prices[id];
    if (!price) return { profit: 0 };
    
    const gasUsd = (200000 * gasGwei * 1e-9) * prices.ethereum;
    const amount = 5000; // Simulated $5k trade
    const spread = 1.015; // Simulated 1.5% dex difference
    const netProfit = (amount * spread - amount) - gasUsd;

    return {
      profit: netProfit.toFixed(2),
      isViable: netProfit > parseFloat(threshold)
    };
  };

  // --- UI THEMES ---
  const theme = isDarkMode ? DarkTheme : LightTheme;

  return (
    <ScrollView style={[styles.container, { backgroundColor: theme.bg }]}>
      {/* Header */}
      <View style={styles.header}>
        <Text style={[styles.title, { color: theme.text }]}>DeFi Engine v1.0</Text>
        <Switch value={isDarkMode} onValueChange={setIsDarkMode} />
      </View>

      {/* Live Market Dashboard */}
      <Animated.View style={[styles.card, { backgroundColor: theme.card, opacity: fadeAnim }]}>
        <View style={styles.row}>
          <Text style={{ color: theme.subText }}>ETH Price</Text>
          {isLoading && <ActivityIndicator size="small" color="#2ecc71" />}
        </View>
        <Text style={[styles.price, { color: theme.accent }]}>${prices.ethereum.toLocaleString()}</Text>
        <Text style={{ color: theme.subText }}>Network Gas: {gasGwei} Gwei</Text>
      </Animated.View>

      {/* Slippage & Simulation Controls */}
      <View style={[styles.card, { backgroundColor: theme.card }]}>
        <Text style={[styles.label, { color: theme.text }]}>Slippage Tolerance: {slippage}%</Text>
        <TextInput 
          style={[styles.input, { color: theme.text, borderColor: theme.subText }]} 
          keyboardType="numeric" 
          value={slippage} 
          onChangeText={setSlippage} 
        />
        
        <View style={[styles.row, { marginTop: 15 }]}>
          <Text style={{ color: theme.text }}>Simulation Mode</Text>
          <Switch value={isSimMode} onValueChange={setIsSimMode} trackColor={{ true: '#f39c12' }} />
        </View>
      </View>

      {/* Arbitrage Scanner */}
      <Text style={[styles.sectionTitle, { color: theme.text }]}>Active Scans</Text>
      {TRACKED_TOKENS.map(token => {
        const arb = calculateArb(token.id);
        return (
          <View key={token.id} style={[styles.arbRow, { backgroundColor: theme.card }]}>
            <Text style={{ color: theme.text, fontWeight: 'bold' }}>{token.symbol}/USD</Text>
            <Text style={{ color: arb.isViable ? '#2ecc71' : '#e74c3c' }}>
              Est. Profit: ${arb.profit}
            </Text>
            <TouchableOpacity style={[styles.btn, { backgroundColor: isSimMode ? '#f39c12' : '#2ecc71' }]}>
              <Text style={{ color: '#fff' }}>{isSimMode ? 'Simulate' : 'Execute'}</Text>
            </TouchableOpacity>
          </View>
        );
      })}
    </ScrollView>
  );
}

// --- STYLES & THEMES ---
const LightTheme = { bg: '#F5F5F5', card: '#FFF', text: '#333', subText: '#666', accent: '#2ecc71' };
const DarkTheme = { bg: '#121212', card: '#1E1E1E', text: '#FFF', subText: '#AAA', accent: '#2ecc71' };

const styles = StyleSheet.create({
  container: { flex: 1, padding: 20, paddingTop: 60 },
  header: { flexDirection: 'row', justifyContent: 'space-between', marginBottom: 20 },
  title: { fontSize: 24, fontWeight: 'bold' },
  card: { padding: 20, borderRadius: 15, marginBottom: 15, elevation: 4 },
  row: { flexDirection: 'row', justifyContent: 'space-between', alignItems: 'center' },
  price: { fontSize: 32, fontWeight: 'bold', marginVertical: 10 },
  label: { fontSize: 14, marginBottom: 5 },
  input: { borderBottomWidth: 1, fontSize: 18, paddingVertical: 5 },
  sectionTitle: { fontSize: 18, fontWeight: 'bold', marginVertical: 15 },
  arbRow: { padding: 15, borderRadius: 10, flexDirection: 'row', justifyContent: 'space-between', alignItems: 'center', marginBottom: 10 },
  btn: { paddingHorizontal: 15, paddingVertical: 8, borderRadius: 8 }
});
